# This config was automatically generated from your source code
# Stacks detected: artifact:go-executable:,deps:go:src
version: 2.1

orbs:
  python: circleci/python@2.0.3

jobs:
  test-webserver:
    # Install go modules and run tests
    docker:
      - image: cimg/go:1.20
    working_directory: ~/project/src
    resource_class: medium
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          key: go-mod-{{ checksum "go.sum" }}
      - run:
          name: Download Go modules
          command: go mod download
      - save_cache:
          key: go-mod-{{ checksum "go.sum" }}
          paths:
            - /home/circleci/go/pkg/mod
      - run:
          name: Start webserver
          command: go run .
      - run:
          name: Run tests
          command: python -m pytest refactored_tests.py --junitxml=junit.xml
      - store_test_results:
          path: junit.xml
  test-apiserver:
    # Install go modules and run tests
    docker:
      - image: cimg/go:1.20
    working_directory: ~/project/api
    resource_class: medium
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          key: go-mod-{{ checksum "go.sum" }}
      - run:
          name: Download Go modules
          command: go mod download
      - save_cache:
          key: go-mod-{{ checksum "go.sum" }}
          paths:
            - /home/circleci/go/pkg/mod
      - run:
          name: Start apiserver
          command: go run .
      - run:
          name: Run tests
          command: python -m pytest api_sim_test.py --junitxml=junit.xml
      - store_test_results:
          path: junit.xml
  deploy:
    # This is an example deploy job, not actually used by the workflow
    docker:
      - image: cimg/base:stable
    resource_class: medium
    steps:
      # Replace this with steps to deploy to users
      - run:
          name: deploy
          command: '#e.g. ./deploy.sh'
workflows:
  build-and-test:
    jobs:
      - test-webserver
      - test-apiserver
    # - deploy:
    #     requires:
    #       - build-go-executables
